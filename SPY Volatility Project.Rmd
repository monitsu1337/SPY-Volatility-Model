---
title: "SPY Volatility Modeling Using ARIMA and GARCH"
author: "Daniel Volkov"
date: "`r Sys.Date()`"
output: html_document
---

# Overview

This project analyzes the volatility of the SPY ETF (tracking the S&P 500) using time series analysis in R. We remove autocorrelation in daily returns using an ARIMA model and capture volatility clustering using a GARCH(1,1) model.

# 1. Load Required Libraries

```{r}
library(quantmod)
library(ggplot2)
library(dplyr)
library(stats)
library(tseries)
library(forecast)
library(rugarch)

# Suppress xts package warning about lag() conflicts with dplyr
options(xts.warn_dplyr_breaks_lag = FALSE)
```

# 2. Data Collection and Preparation

Download SPY daily closing prices and convert them into a data frame for plotting.

```{r}
spy_data <- getSymbols("SPY", from = "2015-01-01", to = Sys.Date(), src = "yahoo", auto.assign = FALSE)
spy_close <- Cl(spy_data)
spy_df <- data.frame(
  Date = index(spy_close),
  Price = as.numeric(spy_close)
)
```

Visualize the SPY daily closing prices.

```{r}
ggplot(spy_df, aes(x = Date, y = Price)) +
  geom_line(color = "blue", linewidth = 1) +
  labs(title = "SPY Daily Closing Price", x = "Date", y = "Price") +
  theme_minimal()
```

# 3. Log Returns Calculation and Visualization

Calculate daily log returns and display them.

```{r}
returns_xts <- dailyReturn(spy_data, type = "log")
returns_df <- data.frame(
  Date = index(returns_xts),
  Returns = as.numeric(returns_xts)
)

head(returns_df)
```

Visualize the daily log returns.

```{r}
ggplot(returns_df, aes(x = Date, y = Returns)) +
  geom_line(color = "darkgreen", linewidth = 1) +
  labs(title = "SPY Daily Log Returns", x = "Date", y = "Log Return") +
  theme_minimal()
```

# 4. Exploratory Data Analysis

Plot the histogram and density curve of the returns.

```{r}
ggplot(returns_df, aes(x = Returns)) +
  geom_histogram(aes(y = after_stat(density)), bins = 50, fill = "lightblue", color = "black") +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Histogram of SPY Daily Log Returns", x = "Returns", y = "Density") +
  theme_minimal()
```

Autocorrelation plots using base R.

```{r}
acf(returns_xts, main = "ACF of SPY Daily Log Returns")
acf(returns_xts^2, main = "ACF of Squared SPY Daily Log Returns")
```

Visualize squared returns as a proxy for volatility.

```{r}
returns_df <- returns_df %>% mutate(Squared_Returns = Returns^2)

ggplot(returns_df, aes(x = Date, y = Squared_Returns)) +
  geom_col(fill = "purple") +
  labs(title = "Squared SPY Daily Log Returns (Volatility Proxy)", x = "Date", y = "Squared Return") +
  theme_minimal()
```

# 5. Stationarity Testing

Perform the Augmented Dickey-Fuller (ADF) and KPSS tests.

```{r}
adf_result <- adf.test(returns_df$Returns)
print(adf_result)

kpss_result <- kpss.test(returns_df$Returns)
print(kpss_result)
```

# 6. ARIMA Model Fitting

Fit an ARIMA model to the returns and extract residuals.

```{r}
arima_fit <- auto.arima(returns_df$Returns)
summary(arima_fit)

arima_residuals <- residuals(arima_fit)
residuals_df <- data.frame(Date = returns_df$Date, Residuals = as.numeric(arima_residuals))
```

Visualize ARIMA residuals.

```{r}
ggplot(residuals_df, aes(x = Date, y = Residuals)) +
  geom_line(color = "darkred", linewidth = 1) +
  labs(title = "ARIMA Model Residuals", x = "Date", y = "Residuals") +
  theme_minimal()
```

# 7. GARCH Model Estimation

Specify and fit the GARCH(1,1) model.

```{r}
spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  mean.model = list(armaOrder = c(0, 0), include.mean = TRUE),
  distribution.model = "norm"
)

garch_fit <- ugarchfit(spec = spec, data = arima_residuals)
show(garch_fit)

sigma_fitted <- sigma(garch_fit)

fitted_vol_df <- data.frame(
  Date = returns_df$Date,
  Volatility = as.numeric(sigma_fitted)
)
```

Visualize the fitted conditional volatility.

```{r}
ggplot(fitted_vol_df, aes(x = Date, y = Volatility)) +
  geom_line(color = "orange", linewidth = 1) +
  labs(title = "Fitted Volatility from GARCH(1,1) Model", x = "Date", y = "Volatility") +
  theme_minimal()
```

# 8. Volatility Forecasting

Forecast the next 30 days of volatility.

```{r}
garch_forecast <- ugarchforecast(garch_fit, n.ahead = 30)
sigma_forecast <- sigma(garch_forecast)

forecast_df <- data.frame(
  Day = 1:length(sigma_forecast),
  Volatility = as.numeric(sigma_forecast)
)
```

Visualize the forecasted volatility.

```{r}
ggplot(forecast_df, aes(x = Day, y = Volatility)) +
  geom_line(color = "steelblue", linewidth = 1) +
  labs(title = "Forecasted Volatility (Next 30 Days)", x = "Days Ahead", y = "Volatility") +
  theme_minimal()
```

